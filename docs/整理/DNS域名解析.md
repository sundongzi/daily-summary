##### DNS是什么？

- 一个由分层的DNS服务器实现的`分布式数据库`

- 一个使得主机能够查询分布式数据库的`应用层协议`

  应用层协议：发送一个请求，其中包含要查询的主机名，返回这个主机名对应的IP

##### DNS类型（三种）

1. 根DNS服务器
2. 顶级DNS服务器（Top-Level Domain, TLD）
3. 权威DNS服务器
4. 本地DNS服务器（不属于DNS层次结构）

##### 递归查询、迭代查询

![image-20221229101529606](/Users/sundong/Library/Application Support/typora-user-images/image-20221229101529606.png)

1. 主机`m.n.com`向它的`本地DNS服务器`发送一个DNS查询报文，其中包含期待被转换的主机名`a.b.com`
2. 本地DNS服务器将报文转发到根DNS服务器
3. 根DNS服务器发现`com`后缀，向本地服务器返回`com`对应的顶级DNS服务器的IP地址列表（根DNS服务器并不知道a.b.com的IP，不过相关的顶级DNS服务器可能知道）
4. 本地DNS服务器向其中一台顶级DNS服务器发送查询报文
5. 顶级DNS服务器发现`b.com`后缀，便向本地DNS服务器返回权威DNS服务器的IP地址
6. 本地DNS服务器又向其中一台权威DNS服务器发送查询报文
7. 该权威服务器返回了`a.b.com`的IP地址给本地DNS服务器
8. 本地DNS服务器将`a.b.com`和IP地址的映射返回给主机`m.n.com`，`m.n.com`就可以用该IP发送请求到`a.b.com`



主机 `m.n.com` 向本地 DNS 服务器 `dns.n.com` 发出的查询就是**递归查询**，这个查询是主机 `m.n.com` 以自己的名义向本地 DNS 服务器请求想要的 IP 映射，并且本地 DNS 服务器直接返回映射结果给到主机。

而后继的三个查询是**迭代查询**，包括本地 DNS 服务器向根 DNS 服务器发送查询请求、本地 DNS 服务器向 TLD 服务器发送查询请求、本地 DNS 服务器向权威 DNS 服务器发送查询请求，**所有的请求都是由本地 DNS 服务器发出，所有的响应都是直接返回给本地 DNS 服务器**。

需要注意的是并不是所有的DNS查询都遵循`递归 + 迭代`的模式，理论上`DNS查询既可以是递归的，也可以是迭代的`。以下查询就是递归的，不包含迭代。

![image-20221229105629982](/Users/sundong/Library/Application Support/typora-user-images/image-20221229105629982.png)

还需要注意的是顶级DNS服务器并不一定都知道权威DNS服务器的IP地址，有时候可能只知道中间的某个DNS服务器，再由这个中间 DNS 服务器去找到权威 DNS 服务器。这种时候，整个查询过程就需要更多的 DNS 报文。

##### DNS缓存

DNS 缓存的原理非常简单，在一个 DNS 查询的过程中，当某一台 DNS 服务器接收到一个 DNS 应答（例如，包含某主机名到 IP 地址的映射）时，它就能够将映射缓存到本地，下次查询就可以直接用缓存里的内容。当然，缓存并不是永久的，每一条映射记录都有一个对应的生存时间，一旦过了生存时间，这条记录就应该从缓存移出。

事实上，**有了缓存，大多数 DNS 查询都绕过了根 DNS 服务器**，需要向根 DNS 服务器发起查询的请求很少。

[字节面试被虐后，是时候搞懂DNS了](https://juejin.cn/post/6990344840181940261)