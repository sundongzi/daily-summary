1. Agent管理=》安装Agent功能优化 && 追加授权配置功能

   ```
   优化后：代码减少110行，页面加载速度提升3s
   ```

<img src="/Users/sundong/Library/Application Support/typora-user-images/image-20230811161926125.png" alt="image-20230811161926125" style="zoom: 50%;" />



```vue
<template>
  <div class="table-news">
    <!-- 表格上方按钮：通过插槽实现左右按钮功能 -->
    <div
        ref="layout"
        class="layout"
        :style="isGray && 'background-color: var(--light-gray-2)'"
        :class="layoutClass">
        <div class="layout-left">
          <slot name="layout_left"></slot>
        </div>
        <div
          class="layout-right"
          ref="layout_right">
          <!-- 布局插槽，过滤器右侧显示该内容 -->
          <slot name="layout_right"></slot>
        </div>
    </div>

   <div style="position: relative">
     <!-- 自定义列按钮 -->
      <el-button setting class="table-fixed-right-setting-btn" @click="$emit('setCustomColumn')"
        v-if="_customColumnOption.show">
        <!-- @TODO:图标 -->
        设置
      </el-button>
   </div>

    <!-- 表格 -->
    <el-table
        ref="table"
        border
        style="width: 100%"
        v-loading="tableLoading"
        :key="tableKey"
        :max-height="maxHeight"
        :data="currentTable.content"
        v-bind="_tableProps"
        v-on="tableListeners"
        @sort-change="tableChangeHandle"
        @selection-change="selectionChangeHandle"
        @expand-change="tableExpandHandle">
        <template slot="empty">
          <slot name='empty'>
            <!-- @TODO:暂无数据 -->
          </slot>
        </template>
        <!-- 表格复选框 -->
        <el-table-column
          v-bind="selectionProps"
          align="center"
          type="selection"
          v-if="showSelection"
          :selectable="canSelectableHandler"
          :label-class-name="`${selectAllStatus === true ? 'is-disabled' : ''}`"
          :reserve-selection="reserveSelection">
        </el-table-column>
        <!-- 表格序号 -->
        <el-table-column v-if="showSerialNumber" v-bind="_indexProps" type="index"></el-table-column>
        <el-table-column
          v-for="column of columnList"
          v-bind="columnBindProps(column)"
          :key="column.label + column.prop + column.key"
          :label="column.label"
          :label-class-name="column.showBorderRight ? 'show-border-right' : ''"
          :prop="column.prop">
          <template v-slot="scope">
            <!-- @TODO:tooltip展示 -->
            <div class="idss-text-overflow">
              <slot :name="column.prop" v-bind="scope">
                <!-- @TODO:没有数据是如何展示？ -->
                <span>{{ scope.row[column.prop] }}</span>
              </slot>
            </div>
          </template>
          <!-- 表格 header 自定义 slot -->
          <template v-slot:header="scope" v-if="$scopedSlots['header:' + column.prop]">
            <slot :name="'header:' + column.prop" v-bind="scope"></slot>
          </template>
        </el-table-column>
    </el-table>

    <slot name="pagination">
      <el-pagination
        v-show="currentTable.totalElements"
        v-bind="_paginationProps"
        :current-page.sync="currentTable.pageNumber"
        :page-size="currentTable.pageSize"
        :total="currentTable.totalElements"
        @size-change="initTable({ pageSize: $event, type: 'sizeChange' })"
        @current-change="initTable({ pageNumber: $event, type: 'pageChange' })">
      </el-pagination>
    </slot>
  </div>
</template>
<script>
import tableMixins from '@/mixins/tableMixin.js'
import request from '@/utils/request/index.js'
import { PAGE_SIZES, PAGE_LAYOUT } from "@/utils/enume";

export default {
  name: 'table-news',
  mixins: [tableMixins],
  props: {
    tableApiLazy: {
      type: Boolean,
      default: false
    },
    tableApi: {
      type: Object,
      default: () => {}
    },
    indexProps: {
      type: Object,
      default: () => {}
    },
    selectionProps: {
      type: Object,
      default: () => {}
    },
    showSelection: {
      type: Boolean,
      default: false
    },
    showSerialNumber: {
      type: Boolean,
      default: false
    },
    // 表格数据
    tableData: {
      type: Object,
      default () {
        return {
          content: []
        }
      }
    },
    // 表格每一列的配置
    columnList: {
      type: Array,
      required: true
    },
    // 是否显示全选按钮
    showSelectAll: {
      type: Boolean,
      default: false
    },
    // 表格最大高度
    maxHeight: {
      type: [Number, String],
      default () {
        return this.TABLE_HEIGHT?.HIGH ?? 885
      }
    },
    // 设置当前行是否可勾选
    selectable: {
      type: Function,
      default: () => true
    },
    // 设置在数据更新之后是否保留之前选中的数据
    reserveSelection: {
      type: Boolean,
      default: true
    },
    // 表格 props
    tableProps: {
      type: Object,
      default () {
        return {
          'rowKey': 'id'
        }
      }
    },
    // 分页 props
    paginationProps: {
      type: Object,
      default: () => ({})
    },
    isGray: {
      type: Boolean,
      default: true
    },
    // 回显数据列表，echoData不为空时，在search()方法查询结束后进行回显操作。@FIXME默认使用者在表格显隐切换会重新查询。
    echoData: {
      type: Array,
      default: () => ([])
    },
    // 自定义列配置
    customColumnOption: {
      type: Object,
      default: () => ({})
    },
    // 查询参数
    searchParams: {
      type: Object,
      default: () => {}
    }
  },
  computed: {
    tableListeners () {
      return Object.fromEntries(Object.entries(this.$listeners).filter(([key]) => {
        // 过滤掉 selection-change 方法，防止穿透到 el-table 中
        return key !== 'selection-change' && key !== 'selectionChange'
      }))
    },
    // 表头排序后后 表格里的 render函数未重新渲染 借助自定义key强制dom重新渲染
    tableKey () {
      return this.columnList && +new Date()
    },
    layoutClass () {
      return this.filterHidden ? 'layout-wrap' : ''
    },
    _tableProps () {
      return Object.assign({
        rowKey: 'id'
      }, this.tableProps)
    },
    _paginationProps () {
      return Object.assign({
        'page-sizes': PAGE_SIZES,
        'layout': PAGE_LAYOUT
      }, this.paginationProps)
    },
    // 序号列配置
    _indexProps () {
      // 展示序号时，合并配置项
      return this.showSerialNumber && Object.assign({
        label: '序号',
        width: '60',
        align: 'center'
      }, this.indexProps)
    },
    // 结合 echoData 与 multipleSelection 返回给 selection-change 事件
    _composeMultipleSelection () {
      return this.selfEchoData.length > 0 ? [].concat(this.selfEchoData, this.multipleSelection) : this.multipleSelection
    },
    _customColumnOption () {
      return this.customColumnOption
      // return merge(DEFAULT_CUSTOM_COLUMN_OPTION, this.customColumnOption)
    },
    // 当前表格数据源
    currentTable () {
      return this.tableApi ? this.table : this.tableData
    }
  },
  watch: {
    // 监听查询参数发生变化，重新发起请求
    searchParams: {
      deep: true,
      handler () {
        console.log('1213131')
        this.tableApi && this.search()
      }
    },
    // 数据回显，用于弹窗编辑
    echoData: {
      immediate: true,
      deep: true,
      handler (newVal = []) {
        // 更新 echoData
        this.selfEchoData = newVal.map(v => {
        // 如果是只传 id 的情况
        // 其余默认为对象的情况，不做处理
          return typeof v === 'string' ? { [this.tableProps.rowKey]: v } : v
        })
        if (newVal.length > 0) {
          this.$emit('selection-change', this._composeMultipleSelection)
        }
      }
    }
  },
  data () {
    return {
      tableLoading: false,
      table: {
        content: [],
        pageNumber: 1,
        pageSize: 10
      },
      selfEchoData: [],
      multipleSelection: [],
      form: JSON.stringify(JSON.parse(this.searchParams))
    }
  },
  methods: {
    columnBindProps (column) {
      return column

    },
     // CheckBox 选中事件
    selectionChangeHandle (arr) {
      this.multipleSelection = arr
      const rowKey = this.tableProps['rowKey']
      // 过滤掉 echoData 中已有的，使用 multipleSelection 的行
      this.selfEchoData = this.selfEchoData.filter(val => !arr.find(row => row[rowKey] === val[rowKey]))
      this.$emit('selection-change', this._composeMultipleSelection)
    },
    /**
     * 根据传入数据列表，在表格内勾选相应数据，使用静态数据时需要自行调用该方法
     * @param {Array[Object]} rows 勾选的行数据或者行数据对应的‘rowKey’的值
     */
    async toggleSelection (rows, selected = true) {
      if (!Array.isArray(rows)) return
      if (rows?.length) {
        rows.forEach(row => {
          let tempRow = this.tableData.find(item => {
            if (typeof row === 'string') {
              return item[this.tableProps['rowKey']] === row
            }
            return item[this.tableProps['rowKey']] === row[this.tableProps['rowKey']]
          })
          tempRow && this.$refs.table.toggleRowSelection(tempRow, selected)
        })
      }
    },
    // 表格展开事件
    tableExpandHandle (row, expandedRows) {
      // expandedRows.includes(row) 为 true 表示展开，反之收起
      // 如果 expandedRows 不是数组，说明是 tree 格式的展开（格式是 Boolean）
      this.$emit('expand-change', row, Array.isArray(expandedRows) ? expandedRows.includes(row) : expandedRows)
    },
    // 当前行是否允许勾选
    canSelectableHandler (row, index) {
      if (this.showSelectAll) {
        return this.checkSelectable()
      }
      return this.selectable(row, index)
    },
    // 全选操作表格勾选
    chooseAllPages () {
      let tableList = this.tableData
      // @FIXME 目前toggleRowSelection处理会触发多次的选中事件
      if (this.selectAllStatus) {
        tableList.forEach(row => {
          this.$refs.table.toggleRowSelection(row, true)
        })
      }
    },
    // 全选封装select勾选状态函数
    checkSelectable () {
      return !this.selectAllStatus
    },
    // 表格变化，分页，排序变化等
    async tableChangeHandle (param) {
      this.$emit('table-change', param)
      await this.$nextTick()
      this.tableApi && await this.initTable(param)
      this.chooseAllPages()
    },
    // 清空勾选项
    clearSelection () {
      const table = this.$refs.table
      if (table) {
        table.clearSelection()
      }
    },
    search () {
      // 如果传递了 table api，发起请求
      this.tableApi && this.initTable({ type: 'submit' })
      // 清空表格数据
      this.clearSelection()
    },
    // 获取表格数据
    // request = (url, data = {}, method)
    async getTableData() {
      const {url, method = 'get'} = this.tableApi
      try {
        const {pageNumber = 1, pageSize = 10, sorts} = this.table
        // @FIXME:页码问题理论上需要后端处理，目前传参时需要默认减1
        let query = Object.assign(
        {
          pageNum: pageNumber > 0 ? pageNumber - 1 : pageNumber,// 当前页码
          pageSize, // 每页条数
          sorts
        },
        this.searchParams
      )
        let result = await request(url, query, method)
        // 前端分页组件从1开始，但请求参数默认从0开始
        result.pageNumber = result.pageNumber + 1
        this.table = result
      } catch(err) {
        return
      }

      // 查询完毕后勾选回显数据
      this.toggleSelection(this.selfEchoData)
    },
    /**
     * 初始化表格数据获取
     */
    async initTable (param = { type: 'init' }) {
      await this.tableChange(param, this.table, this.getTableData)
    }
  },
  created () {
    !this.tableApiLazy && this.tableApi && this.initTable()
  }
}
</script>
<style lang="postcss" scoped>
.table-news {
  .layout {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .table-fixed-right-setting-btn{
    position: absolute;
    right: 0;
    top: 0;
    z-index: 9;
  }
}
</style>

```



